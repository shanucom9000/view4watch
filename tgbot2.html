<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>API Admin Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg,#0f172a,#020617);
  color:white;
}
header {
  padding:20px;
  font-size:22px;
  font-weight:bold;
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(10px);
}
.container { padding:20px; }
.cards {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
  margin-bottom:20px;
}
.card {
  background: rgba(255,255,255,0.05);
  padding:20px;
  border-radius:12px;
}
table {
  width:100%;
  border-collapse: collapse;
  margin-top:10px;
}
th, td {
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,0.1);
  text-align:center;
}
button {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2563eb;
  color:white;
}
input, textarea {
  padding:8px;
  border-radius:6px;
  border:none;
  margin:5px;
}
.section { margin-top:30px; }
.theme-toggle { float:right; cursor:pointer; }
.light { background:#f8fafc; color:#111; }
</style>
</head>

<body>

<header>
ğŸš€ API Admin Dashboard
<span class="theme-toggle" onclick="toggleTheme()">ğŸŒ—</span>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginBox">
<h2>Admin Login</h2>
<input id="user" placeholder="Username"><br>
<input id="pass" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<p id="loginMsg"></p>
</div>

<div id="dashboard" style="display:none">

<!-- STATS -->
<div class="cards">
  <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
  <div class="card"><h3>Active Keys</h3><p id="activeKeys">0</p></div>
  <div class="card"><h3>Total Usage</h3><p id="totalUsage">0</p></div>
</div>

<!-- USERS -->
<div class="section">
<h2>ğŸ‘¥ Users</h2>
<input id="searchBox" placeholder="Search UID">
<button onclick="searchUsers()">Search</button>

<table id="usersTable">
<tr><th>UID</th><th>Plan</th><th>Balance</th><th>Usage</th><th>Actions</th></tr>
</table>
</div>

<!-- PROVIDER KEYS -->
<div class="section">
<h2>ğŸ”‘ Provider Keys</h2>
<table id="keysTable">
<tr><th>ID</th><th>Status</th><th>Toggle</th></tr>
</table>
<input id="newKey" placeholder="New API Key">
<button onclick="addKey()">Add Key</button>
</div>

<!-- BROADCAST -->
<div class="section">
<h2>ğŸ“¢ Broadcast</h2>
<textarea id="broadcastMsg" rows="3" style="width:100%"></textarea>
<button onclick="broadcast()">Send to All</button>
</div>

<!-- USAGE CHART -->
<div class="section">
<h2>ğŸ“Š Usage Chart</h2>
<canvas id="chart"></canvas>
</div>

</div>
</div>

<script>
const API_BASE = "https://instaapipro.onrender.com";
let token="";

function toggleTheme(){
  document.body.classList.toggle("light");
}

/* ================= LOGIN ================= */
function login(){
  const username = document.getElementById("user").value.trim();
  const password = document.getElementById("pass").value.trim();
  const msg = document.getElementById("loginMsg");

  msg.innerText = "";

  if(!username || !password){
    msg.innerText = "âš ï¸ Enter username & password";
    return;
  }

  fetch(`${API_BASE}/admin/login`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  })
  .then(async res=>{
    const data = await res.json();

    if(res.status === 401){
      msg.innerText = "âŒ Incorrect username or password";
      return;
    }

    if(!res.ok){
      msg.innerText = "âš ï¸ API error. Try again.";
      return;
    }

    if(!data.token){
      msg.innerText = "âš ï¸ Login failed";
      return;
    }

    msg.innerText = "âœ… Login successful!";
    token=data.token;
    loginBox.style.display="none";
    dashboard.style.display="block";
    loadData();
  })
  .catch(()=>{
    msg.innerText = "ğŸš« Cannot reach API server";
  });
}

/* ================= LOAD DATA ================= */
function loadData(){
 fetch(`${API_BASE}/admin/users`,{headers:{"X-Admin-Token":token}})
 .then(r=>r.json())
 .then(showUsers);

 fetch(`${API_BASE}/admin/provider_keys`,{headers:{"X-Admin-Token":token}})
 .then(r=>r.json())
 .then(showKeys);
}

/* ================= USERS ================= */
function showUsers(users){
 let table=document.getElementById("usersTable");
 table.innerHTML=`<tr>
 <th>UID</th><th>Plan</th><th>Balance</th><th>Usage</th><th>Actions</th></tr>`;

 let totalUsage=0;

 users.forEach(u=>{
   totalUsage+=u.usage;
   table.innerHTML+=`
   <tr>
     <td>${u.uid}</td>
     <td>${u.plan}</td>
     <td>â‚¹${u.balance}</td>
     <td>${u.usage}</td>
     <td>
       <button onclick="updateBalance('${u.uid}',1)">+â‚¹</button>
       <button onclick="updateBalance('${u.uid}',-1)">-â‚¹</button>
       <button onclick="setPlan('${u.uid}','pro')">Pro</button>
       <button onclick="setPlan('${u.uid}','basic')">Basic</button>
       <button onclick="deleteUser('${u.uid}')">âŒ</button>
       <button onclick="messageUser('${u.uid}')">ğŸ“©</button>
     </td>
   </tr>`;
 });

 totalUsers.innerText=users.length;
 totalUsage.innerText=totalUsage;
 drawChart(users);
}

/* ================= PROVIDER KEYS ================= */
function showKeys(keys){
 let table=document.getElementById("keysTable");
 table.innerHTML="<tr><th>ID</th><th>Status</th><th>Toggle</th></tr>";
 let active=0;

 keys.forEach(k=>{
   if(k.status==="active") active++;
   table.innerHTML+=`
   <tr>
     <td>${k.id}</td>
     <td>${k.status}</td>
     <td><button onclick="toggleKey('${k.id}')">Toggle</button></td>
   </tr>`;
 });

 activeKeys.innerText=active;
}

/* ================= ACTIONS ================= */
function updateBalance(uid,amount){
 fetch(`${API_BASE}/admin/balance`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({uid,amount})
 }).then(loadData);
}

function setPlan(uid,plan){
 fetch(`${API_BASE}/admin/plan`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({uid,plan})
 }).then(loadData);
}

function deleteUser(uid){
 if(!confirm("Delete user?")) return;
 fetch(`${API_BASE}/admin/delete_user`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({uid})
 }).then(loadData);
}

function toggleKey(id){
 fetch(`${API_BASE}/admin/toggle_key`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({id})
 }).then(loadData);
}

function addKey(){
 fetch(`${API_BASE}/admin/add_key`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({key:newKey.value})
 }).then(loadData);
}

function broadcast(){
 fetch(`${API_BASE}/admin/broadcast`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({message:broadcastMsg.value})
 });
}

function messageUser(uid){
 let msg=prompt("Enter message:");
 if(!msg) return;
 fetch(`${API_BASE}/admin/message_user`,{
  method:"POST",
  headers:{"Content-Type":"application/json","X-Admin-Token":token},
  body:JSON.stringify({uid,message:msg})
 });
}

function searchUsers(){
 fetch(`${API_BASE}/admin/search_users?q=${searchBox.value}`,{headers:{"X-Admin-Token":token}})
 .then(r=>r.json())
 .then(showUsers);
}

/* ================= CHART ================= */
function drawChart(users){
 new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{
    labels:users.map(u=>u.uid),
    datasets:[{label:"Usage",data:users.map(u=>u.usage)}]
  }
 });
}

setInterval(loadData,10000);
</script>

</body>
</html>
