<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Watch & Earn</title>
</head>

<body style="background:black;color:white;text-align:center;font-family:sans-serif">

<h2>ğŸ¬ Watch & Earn</h2>
<iframe id="player" width="420" height="240" allowfullscreen></iframe>
<p id="status">ğŸ”„ Verifying...</p>
<p id="timer"></p>

<script>
const API = "https://view4server.onrender.com";
const REQUIRED_TIME = 30;

const token = new URLSearchParams(location.search).get("token");
const player = document.getElementById("player");
const statusEl = document.getElementById("status");
const timerEl = document.getElementById("timer");

let countdown = REQUIRED_TIME;

// ================= VERIFY TOKEN =================
async function verifyToken() {
  const res = await fetch(API + "/verify-token", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ token })
  });

  const data = await res.json();
  console.log(data);

  if (data.status !== "ok") {
    statusEl.innerText = "âŒ Token expired or invalid";
    return;
  }

  player.src = data.url + "?autoplay=1&mute=1";
  statusEl.innerText = "â–¶ï¸ Watching...";
  startTimer();
}

// ================= TIMER =================
function startTimer() {
  timerEl.innerText = "â³ " + countdown + " sec";

  const interval = setInterval(() => {
    countdown--;
    timerEl.innerText = "â³ " + countdown + " sec";

    if (countdown <= 0) {
      clearInterval(interval);
      completeWatch();
    }
  }, 1000);
}

// ================= COMPLETE WATCH =================
async function completeWatch() {
  statusEl.innerText = "ğŸ‰ Rewarding...";

  const res = await fetch(API + "/complete-watch", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ token })
  });

  const data = await res.json();
  console.log(data);

  if (data.status === "rewarded") {
    statusEl.innerText = "âœ… Reward added!";
    timerEl.innerText = "";
  } else {
    statusEl.innerText = "âš ï¸ Could not reward";
  }
}

verifyToken();
</script>

</body>
</html>
