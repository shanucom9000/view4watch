<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Watch & Earn</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body style="background:black;color:white;text-align:center;font-family:sans-serif">

<h2>ğŸ¬ Watch & Earn</h2>

<iframe id="player" width="420" height="240" allowfullscreen></iframe>

<p id="status">ğŸ”„ Verifying...</p>
<p id="timer"></p>

<script>
const API = "https://view4server.onrender.com";
const REQUIRED_TIME = 30; // seconds

const token = new URLSearchParams(location.search).get("token");

const statusEl = document.getElementById("status");
const timerEl = document.getElementById("timer");
const player = document.getElementById("player");

let countdown = REQUIRED_TIME;
let timerInterval = null;

// ================= VERIFY TOKEN =================
async function verifyToken() {
  if (!token) {
    statusEl.innerText = "âŒ Invalid link";
    return;
  }

  try {
    const res = await fetch(API + "/verify-token", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ token })
    });

    const data = await res.json();
    console.log("Verify:", data);

    if (data.status === "expired") {
      statusEl.innerText = "â° Token expired";
      return;
    }

    if (data.status !== "ok") {
      statusEl.innerText = "âŒ Invalid token";
      return;
    }

    // Load video
    player.src = data.url + "?autoplay=1&mute=1";
    statusEl.innerText = "â–¶ï¸ Watching...";
    startTimer();

  } catch (err) {
    statusEl.innerText = "âš ï¸ Server error";
    console.error(err);
  }
}

// ================= TIMER =================
function startTimer() {
  timerEl.innerText = "â³ " + countdown + " seconds remaining";

  timerInterval = setInterval(() => {
    countdown--;
    timerEl.innerText = "â³ " + countdown + " seconds remaining";

    if (countdown <= 0) {
      clearInterval(timerInterval);
      completeWatch();
    }
  }, 1000);
}

// ================= COMPLETE WATCH =================
async function completeWatch() {
  statusEl.innerText = "âœ… Completed! Rewarding...";

  try {
    const res = await fetch(API + "/complete-watch", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ token })
    });

    const data = await res.json();
    console.log("Complete:", data);

    if (data.status === "rewarded") {
      statusEl.innerText = "ğŸ‰ Reward added!";
      timerEl.innerText = "";
    } else {
      statusEl.innerText = "âš ï¸ Could not reward";
    }

  } catch (err) {
    statusEl.innerText = "âš ï¸ Server error";
  }
}

// ================= START =================
verifyToken();
</script>

</body>
</html>
