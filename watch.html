<!DOCTYPE html>
<html>
<body style="background:black;color:white;text-align:center;font-family:sans-serif">

<h2>ğŸ¬ Watch & Earn</h2>
<iframe id="player" width="420" height="240" allowfullscreen></iframe>
<p id="status">ğŸ”„ Verifying...</p>
<p id="timer"></p>

<script>
const API = "https://view4server.onrender.com";
const REQUIRED_TIME = 30;

const token = new URLSearchParams(location.search).get("token");
const player = document.getElementById("player");
const statusEl = document.getElementById("status");
const timerEl = document.getElementById("timer");

const session_id = Math.random().toString(36).substring(2);

let watchTime = 0;
let active = true;

async function verifyToken() {
  const res = await fetch(API + "/verify-token", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ token, session_id })
  });

  const data = await res.json();

  if (data.status === "multi_tab") {
    statusEl.innerText = "âŒ Already open in another tab";
    return;
  }

  if (data.status !== "ok") {
    statusEl.innerText = "âŒ Invalid or expired";
    return;
  }

  player.src = data.url + "?autoplay=1&mute=1";
  statusEl.innerText = "â–¶ï¸ Watching...";
  startTimer();
}

function startTimer() {
  setInterval(() => {
    if (!active) return;

    watchTime++;
    timerEl.innerText = "â³ " + watchTime + " / " + REQUIRED_TIME;

    if (watchTime >= REQUIRED_TIME) {
      completeWatch();
    }
  }, 1000);
}

document.addEventListener("visibilitychange", () => {
  active = !document.hidden;
});

window.addEventListener("blur", () => active = false);
window.addEventListener("focus", () => active = true);

async function completeWatch() {
  statusEl.innerText = "ğŸ‰ Rewarding...";

  const res = await fetch(API + "/complete-watch", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      token,
      watch_time: watchTime
    })
  });

  const data = await res.json();

  if (data.status === "rewarded") {
    statusEl.innerText = "âœ… Reward added!";
  } else if (data.status === "too_fast") {
    statusEl.innerText = "âŒ Fast-forward detected";
  } else {
    statusEl.innerText = "âš ï¸ Error";
  }
}

verifyToken();
</script>
</body>
</html>
